<!DOCTYPE html>
<html>
  <head>
    <title>ansifier</title>
	  <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=yes">
	<link rel="stylesheet" href="static/style.css">
  </head>

  <body>
    <div class="container">
      <h1>ansifier</h1>
	  <p id="description">
      Convert image files to styled HTML or ansi-escaped text<br/>
      for display in text-only browsers and terminals, respectively;<br/>
      A web wrapper for
      <a href="https://github.com/amminer/ansifier" target="_blank">ansifier</a>.<br/>
      Hover over the (i) in a field's label for more information, or read the documentation
      <a href="https://github.com/amminer/ansifier-cloud/blob/main/README.md" target="_blank">here</a>.
    </p>
      
	  <!-- form -->

    <form id="imageForm">
		<div class="requiredSet">
      <div class="input">
        <label for="imageFile">Image File:</label>
        <input class="fileInput" type="file" id="imageFile" name="imageFile">
      </div>

      <span> or </span>

      <div class="input">
        <label for="imageURL">Image URL
          <span disabled class="tooltip"
           title="most image hosts don't like receiving traffic from the cloud, where this application is running - if the URL doesn't work, try downloading the image to your machine, then uploading it using the Image File input.">
            (i)
          </span>:
        </label>
        <input class="fileInput" type="text" id="imageURL" name="imageURL">
      </div>

		</div>
        
		<div class="input">
        <label for="format">Output Format:</label>
        <select id="format" name="format" required>
          <option value="html/css">HTML/CSS</option>
          <option value="ansi-escaped">ANSI Escaped</option>
        </select>
		</div>

		<div class="optional_input">
      <label for="width">Output Width (min. 20, max. 1000):</label>
      <input type="number" id="width" name="width" value=60>
		</div>

		<div class="optional_input">
      <label for="height">Output Height (min. 20, max. 1000):</label>
      <input type="number" id="height" name="height" value=60>
		</div>

	  <div class="optional_input">
      <label for="characters">
		   Characters
			  <span disabled class="tooltip"
          title="characters to be chosen from when converting regions of the image to text. Should be sorted from more opaque to less opaque in normal usage.">
          (i)
        </span>:</label>
      <input type="text" id="characters" name="characters" value="█▓▒░#≡±+÷- ">
	  </div>

	  <div class="optional_input">
      <label for="gallery">
        Submit to text art gallery
          <span disabled class="tooltip"
           title="if checked, the result of ansification will be saved and made publicly viewable to other users. At the time of writing, this is under development and this checkbox doesn't actually do anything :)">
            (i)
          </span>:
      </label>
      <input type="checkbox" id="gallery" name="gallery">
	  </div>

    <input id="submit" type="submit" value="Submit">
      <div id="result"></div>
      <div id="uid-container" class="optional_input" style="display: none;">
        view your output with unique ID <a id="uid" target="_blank"></a>
      </div>
      <div class="optional_input">
        <a id="downloadBtn" style="display: none;">Download Output</a>
      </div>
    </form>

	  <!-- /form -->
    
    <!-- form submission script -->
    <script> document.getElementById("imageForm").onsubmit = async function(event) {
      event.preventDefault();

      let result_container = document.getElementById("result");
      let uid_container = document.getElementById("uid-container");
      let uid_link = document.getElementById("uid");
      let response = null;

      const remote = "/ansify";
      const format = document.getElementById("format").value;
	  const fileInput = document.getElementById("imageFile")
      const imageFilePath = fileInput.value;
      const file = fileInput.files ? fileInput.files[0] : null;
      const imageURL = document.getElementById("imageURL").value;
      const width = document.getElementById("width").value;
      const height = document.getElementById("height").value;
      const characters = document.getElementById("characters").value;
      const gallery = document.getElementById("gallery").checked;

      const formData = new FormData();
      formData.append("format", format);
      formData.append("width", width);
      formData.append("height", height);
      formData.append("characters", characters);
      formData.append("gallery", gallery);
      if (imageFilePath != "") {
        fileInput.value = "";
        console.log("POSTing file", imageFilePath);
        formData.append("file", file);
      } else if (imageURL != "") {
        console.log("POSTing url", imageURL);
        formData.append("url", imageURL);
      } else {
        response = {
          status: 400,
          text: async() => "Please provide a file or URL as input"
        };
      }
      if (response === null) {
        response = await fetch(remote, {
          method: "POST",
          body: formData
        });
	  }

      result_container.innerHTML = `<pre>processing request...</pre>`;
      let result = await response.text();

      if (response.ok) {

        console.log("gallery: " + gallery);
        if (gallery) {  // last line of result will be a uid
          let lines = result.split('\n');
          uid = lines[lines.length - 1];
          lines.pop();
          result = lines.join('\n');
          uid_link.innerHTML = `${uid}`;
          uid_link.href = `/gallery?uid=${uid}`;
          uid_container.style.display = "block";
        } else {
          uid_container.style.display = "none";
        }

        // download link to save the ansified image to the client machine
        const dataUrl = "data:text/plain;charset=utf-8," + encodeURIComponent(result);
        const downloadBtn = document.getElementById("downloadBtn");
        downloadBtn.href = dataUrl;
        downloadBtn.download = format === "html/css"? "output.html" : "output.txt";
        downloadBtn.innerText = "Download Output";
        downloadBtn.style.display = "inline";

      } else { // response is not ok
        downloadBtn.style.display = "none";
        uid_container.style.display = "none";
      }

      result_container.innerHTML = `<pre style="display: block;">${result}</pre>`;
    }; // end of onsubmit func def
    </script>
    <!-- /form submission script -->

  </body>
</html>
